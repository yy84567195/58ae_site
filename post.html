<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Post Ad | 58.ae</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #fcfcfc; touch-action: manipulation; }
        
        /* Âä®ÁîªÁâπÊïà */
        .listening-animation { animation: pulse-red 1.5s infinite; background-color: #fee2e2 !important; border-color: #ef4444 !important; }
        .ai-thinking { background: linear-gradient(90deg, #f0f9ff 0%, #e0f2fe 50%, #f0f9ff 100%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        .upload-dashed { border: 2px dashed #e2e8f0; }
        
        /* È≠îÊ≥ïÊåâÈíÆÁâπÊïà */
        .magic-btn-active { animation: magicPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes magicPop { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
    </style>
</head>
<body class="pb-10 h-screen flex flex-col">

    <nav class="sticky top-0 z-50 bg-white border-b px-4 py-4 flex items-center justify-between">
        <div class="flex items-center">
            <a href="index.html" class="text-slate-900 mr-4 w-8 h-8 flex items-center justify-center active:bg-slate-100 rounded-full transition"><i class="fa-solid fa-xmark text-xl"></i></a>
            <h1 class="text-lg font-extrabold text-slate-900">New Ad</h1>
        </div>
        <button onclick="handlePublish()" id="headerPubBtn" class="text-blue-600 font-bold text-sm disabled:opacity-50">Publish</button>
    </nav>

    <main class="flex-1 p-4 space-y-6 overflow-y-auto">

        <section>
            <h2 class="text-xs font-bold text-slate-400 mb-2 uppercase tracking-wide">1. Media (Photo & Video)</h2>
            <div class="grid grid-cols-3 gap-3">
                
                <input type="file" id="imgInput" accept="image/*" style="display: none;" onchange="previewMedia(event, 'img')">
                <div onclick="document.getElementById('imgInput').click()" id="uploadImgBox"
                     class="upload-dashed aspect-square rounded-2xl flex flex-col items-center justify-center bg-slate-50 cursor-pointer hover:bg-slate-100 transition-colors overflow-hidden relative active:scale-95 duration-200">
                    <div id="imgIcon" class="flex flex-col items-center">
                        <i class="fa-solid fa-camera text-slate-400 text-xl mb-1"></i>
                        <span class="text-[10px] font-bold text-slate-400">PHOTO</span>
                    </div>
                    <img id="imgPreview" class="hidden w-full h-full object-cover absolute top-0 left-0">
                    <div id="removeImgBtn" onclick="removeMedia(event, 'img')" class="hidden absolute top-1 right-1 bg-black/50 w-5 h-5 rounded-full flex items-center justify-center text-white text-xs z-10">‚úï</div>
                </div>

                <input type="file" id="videoInput" accept="video/*" style="display: none;" onchange="previewMedia(event, 'video')">
                <div onclick="document.getElementById('videoInput').click()" id="uploadVideoBox"
                     class="upload-dashed aspect-square rounded-2xl flex flex-col items-center justify-center bg-slate-50 cursor-pointer hover:bg-slate-100 transition-colors overflow-hidden relative active:scale-95 duration-200">
                    <div id="videoIcon" class="flex flex-col items-center">
                        <i class="fa-solid fa-video text-slate-400 text-xl mb-1"></i>
                        <span class="text-[10px] font-bold text-slate-400">VIDEO</span>
                    </div>
                    <video id="videoPreview" class="hidden w-full h-full object-cover absolute top-0 left-0" autoplay muted loop playsinline></video>
                    <div id="removeVideoBtn" onclick="removeMedia(event, 'video')" class="hidden absolute top-1 right-1 bg-black/50 w-5 h-5 rounded-full flex items-center justify-center text-white text-xs z-10">‚úï</div>
                </div>

            </div>
        </section>

        <section class="space-y-4">
            <h2 class="text-xs font-bold text-slate-400 mb-2 uppercase tracking-wide">2. Details</h2>
            
            <div class="relative group">
                <textarea id="adContent" oninput="simulateAIAnalysis()" placeholder="Type details here... (e.g., selling car, good condition)" 
                    class="w-full h-40 p-4 bg-slate-50 border-none rounded-2xl text-sm focus:ring-2 ring-blue-500 outline-none resize-none transition-all"></textarea>
                
                <button onclick="polishContent()" id="magicBtn" class="absolute bottom-3 right-3 bg-white border border-slate-200 shadow-sm text-xs font-bold text-slate-600 px-3 py-1.5 rounded-full flex items-center gap-1 active:scale-90 transition hover:text-blue-600 hover:border-blue-300">
                    <i class="fa-solid fa-wand-magic-sparkles text-purple-500"></i> AI Polish
                </button>
            </div>
            
            <input type="text" id="adTitle" placeholder="Add a short title..." class="w-full p-4 bg-slate-50 border-none rounded-2xl text-sm font-bold focus:ring-2 ring-blue-500 outline-none">
        </section>

        <section id="aiCard" class="bg-white rounded-2xl border border-slate-100 p-4 shadow-sm transition-all">
            <div class="flex items-center gap-2 mb-3">
                <i class="fa-solid fa-robot text-blue-600"></i>
                <h2 class="text-xs font-extrabold uppercase text-slate-900">AI Assistant</h2>
            </div>
            <div class="space-y-2">
                <div class="flex justify-between text-xs items-center">
                    <span class="text-slate-400">Category:</span>
                    <span id="aiCategory" class="font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded-md">General</span>
                </div>
                <div class="flex justify-between text-xs items-center">
                    <span class="text-slate-400">Est. Price:</span>
                    <input type="number" id="manualPrice" placeholder="0" class="w-20 text-right font-bold text-slate-900 bg-transparent outline-none border-b border-slate-200 focus:border-blue-500">
                </div>
            </div>
        </section>

        <div class="pt-4 pb-8">
            <button onclick="handlePublish()" id="mainPubBtn" class="w-full bg-slate-900 text-white py-4 rounded-2xl shadow-xl flex items-center justify-center gap-2 active:scale-95 transition-all">
                <span class="font-extrabold text-lg">Post Now</span>
                <i class="fa-solid fa-arrow-right"></i>
            </button>
        </div>

    </main>

    <script>
        const SB_URL = 'https://kjapiymhfevoansimuay.supabase.co';
        const SB_KEY = 'sb_publishable_C-OMH06nSEgCzRXC9pmjRg_cu-Ntg8L'; 
        const sbClient = supabase.createClient(SB_URL, SB_KEY);

        let selectedImg = null;
        let selectedVideo = null;

        // --- 1. Â™í‰ΩìÂ§ÑÁêÜ (ÂõæÁâá & ËßÜÈ¢ë) ---
        function previewMedia(event, type) {
            const file = event.target.files[0];
            if (!file) return;

            const src = URL.createObjectURL(file);
            
            if (type === 'img') {
                selectedImg = file;
                document.getElementById('imgIcon').classList.add('hidden');
                document.getElementById('imgPreview').src = src;
                document.getElementById('imgPreview').classList.remove('hidden');
                document.getElementById('removeImgBtn').classList.remove('hidden');
            } else {
                // ËßÜÈ¢ëÊñá‰ª∂Â§ßÂ∞èÊ£ÄÊü• (ÈôêÂà∂ 50MB)
                if (file.size > 50 * 1024 * 1024) return alert("Video too large! Max 50MB.");
                selectedVideo = file;
                document.getElementById('videoIcon').classList.add('hidden');
                document.getElementById('videoPreview').src = src;
                document.getElementById('videoPreview').classList.remove('hidden');
                document.getElementById('removeVideoBtn').classList.remove('hidden');
            }
        }

        function removeMedia(e, type) {
            e.stopPropagation();
            if (type === 'img') {
                selectedImg = null;
                document.getElementById('imgInput').value = "";
                document.getElementById('imgPreview').classList.add('hidden');
                document.getElementById('imgIcon').classList.remove('hidden');
                document.getElementById('removeImgBtn').classList.add('hidden');
            } else {
                selectedVideo = null;
                document.getElementById('videoInput').value = "";
                document.getElementById('videoPreview').classList.add('hidden');
                document.getElementById('videoIcon').classList.remove('hidden');
                document.getElementById('removeVideoBtn').classList.add('hidden');
            }
        }

        // --- 2. ‚ú® AI Ê∂¶Ëâ≤ (Ê†∏ÂøÉÂçáÁ∫ß) ---
        function polishContent() {
            const textarea = document.getElementById('adContent');
            const btn = document.getElementById('magicBtn');
            const originalText = textarea.value.trim();
            const category = document.getElementById('aiCategory').innerText;

            if (!originalText) return alert("Please type a few words first!");

            // ÊåâÈíÆÂä®Áîª
            btn.classList.add('magic-btn-active');
            btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin text-purple-500"></i> Polishing...`;
            
            // Ê®°Êãü AI ÊÄùËÄÉÂª∂Ëøü
            setTimeout(() => {
                let polishedText = "";

                // ÁÆÄÂçïÁöÑÊú¨Âú∞ AI Ê®°ÊùøÈÄªËæë (Ê®°Êãü GPT)
                if (category === 'Motors') {
                    polishedText = `üî• FOR SALE: Amazing Opportunity!\n\n${originalText}\n\n‚úÖ GCC Specs & Accident Free\n‚úÖ Low Mileage, Excellent Condition\n‚úÖ Well Maintained, Lady Driven\n\nMust see to appreciate! Contact now for a quick deal.`;
                } else if (category === 'Property') {
                    polishedText = `üè° PREMIUM LISTING: Don't Miss Out!\n\n${originalText}\n\n‚ú® Prime Location, Close to Metro\n‚ú® Spacious Layout & Modern Design\n‚ú® Ready to Move In\n\nPerfect for families or professionals. Viewing available daily!`;
                } else if (category === 'Jobs') {
                    polishedText = `üëî HIRING NOW: Join Our Team!\n\nWe are looking for: ${originalText}\n\nüîπ Competitive Salary & Benefits\nüîπ Growth Opportunities\nüîπ Visa Provided\n\nApply today! Send your CV now.`;
                } else {
                    polishedText = `üåü HOT DEAL: ${originalText}\n\n- High Quality Item\n- Best Price in Market\n- Serious Buyers Only\n\nDM me for more details! First come first serve.`;
                }

                textarea.value = polishedText;
                btn.innerHTML = `<i class="fa-solid fa-check text-green-500"></i> Done!`;
                btn.classList.remove('magic-btn-active');
                
                // 3ÁßíÂêéÊÅ¢Â§çÊåâÈíÆ
                setTimeout(() => { btn.innerHTML = `<i class="fa-solid fa-wand-magic-sparkles text-purple-500"></i> AI Polish`; }, 3000);
            }, 1000);
        }

        // --- 3. ‰º™ AI ÂàÜÊûêÂàÜÁ±ª ---
        let aiTimeout;
        function simulateAIAnalysis() {
            const text = document.getElementById('adContent').value.toLowerCase();
            const aiCard = document.getElementById('aiCard');
            const catEl = document.getElementById('aiCategory');
            
            aiCard.classList.add('ai-thinking');
            catEl.innerText = "Analyzing...";

            clearTimeout(aiTimeout);

            aiTimeout = setTimeout(() => {
                aiCard.classList.remove('ai-thinking');
                if (text.includes('car') || text.includes('bmw') || text.includes('drive')) catEl.innerText = "Motors";
                else if (text.includes('room') || text.includes('villa') || text.includes('rent')) catEl.innerText = "Property";
                else if (text.includes('phone') || text.includes('laptop')) catEl.innerText = "Market";
                else if (text.includes('job') || text.includes('hiring')) catEl.innerText = "Jobs";
                else catEl.innerText = "General";
            }, 800);
        }

        // --- 4. ÂèëÂ∏ÉÈÄªËæë ---
        async function handlePublish() {
            const content = document.getElementById('adContent').value.trim();
            const title = document.getElementById('adTitle').value.trim();
            const price = document.getElementById('manualPrice').value || "Contact";
            const category = document.getElementById('aiCategory').innerText;
            const btn = document.getElementById('mainPubBtn');
            
            if (!content || !title) return alert("Please enter Title and Details!");

            btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Publishing...`;
            btn.disabled = true;

            try {
                // Ê®°ÊãüÂ™í‰Ωì‰∏ä‰º† (ÁúüÂÆûÁéØÂ¢ÉÈúÄË¶Å Storage Ê°∂)
                let finalImageUrl = 'https://images.unsplash.com/photo-1550525811-e5869dd03032?auto=format&fit=crop&w=800&q=80';
                
                // Â¶ÇÊûúÁî®Êà∑ÈÄâ‰∫ÜÂõæÁâáÔºåÊàë‰ª¨Áî®Êú¨Âú∞ Blob URL È™ó‰∏Ä‰∏ãËßÜËßâ (Âà∑Êñ∞‰ºö‰∏¢Ôºå‰ΩÜ‰Ωú‰∏∫ÊºîÁ§∫Ë∂≥Â§üÈúáÊíº)
                // ÁúüÂÆûÈÄªËæëÊòØ await sbClient.storage.from('images').upload...
                if (category === 'Motors') finalImageUrl = 'https://images.unsplash.com/photo-1552519507-da3b142c6e3d?auto=format&fit=crop&w=800&q=80';
                if (category === 'Property') finalImageUrl = 'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?auto=format&fit=crop&w=800&q=80';

                // ÂÜôÂÖ•Êï∞ÊçÆÂ∫ì
                const { error } = await sbClient.from('posts').insert([{ 
                    title: title, 
                    description: content + `\n\nPrice: AED ${price}`, 
                    category: category,
                    image_url: finalImageUrl,
                    // Â¶ÇÊûú‰Ω†ÁöÑË°®Ê≤°Êúâ video_url Â≠óÊÆµÔºåËøôË°åÂèØËÉΩ‰ºöÊä•ÈîôÔºåÊâÄ‰ª•ÊàëÊöÇÊó∂Ê≥®ÈáäÊéâ
                    // video_url: selectedVideo ? 'https://example.com/video.mp4' : null,
                    created_at: new Date()
                }]);

                if (error) throw error;

                setTimeout(() => { window.location.href = 'index.html'; }, 1000);

            } catch (err) {
                alert('Error: ' + err.message);
                btn.innerHTML = `Post Now <i class="fa-solid fa-arrow-right"></i>`;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>